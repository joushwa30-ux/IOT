/*
   ESP32 <- Control LED from ThingSpeak
*/

#include <WiFi.h>
#include <HTTPClient.h>

// WiFi credentials
const char* ssid = "DESKTOP-TJNR2MP 7176";
const char* password = "CBMR104B";

// ThingSpeak Read settings
const char* server = "http://api.thingspeak.com";
String channelID = "3279002";
String readAPIKey = "VDX0AD6DVTJ9B02A";

// LED pin (built-in LED usually GPIO 2)
const int ledPin = 2;

void initWiFi() {
  WiFi.mode(WIFI_STA);
  WiFi.begin(ssid, password);
  Serial.print("Connecting to WiFi ..");

  while (WiFi.status() != WL_CONNECTED) {
    Serial.print('.');
    delay(1000);
  }

  Serial.println("\nConnected!");
  Serial.print("IP address: ");
  Serial.println(WiFi.localIP());
}

void setup() {
  Serial.begin(115200);
  pinMode(ledPin, OUTPUT);
  initWiFi();
}

void loop() {

  if (WiFi.status() == WL_CONNECTED) {

    HTTPClient http;

    // URL to read last value of field1
    String url = String(server) + "/channels/" + channelID +
                 "/fields/1/last.txt?api_key=" + readAPIKey;

    Serial.println("Checking ThingSpeak for LED command...");

    http.begin(url);
    int httpResponseCode = http.GET();

    if (httpResponseCode > 0) {

      String payload = http.getString();
      payload.trim();  // remove spaces/newlines

      Serial.print("Received from ThingSpeak: ");
      Serial.println(payload);

      int ledState = payload.toInt();

      if (ledState == 1) {
        digitalWrite(ledPin, HIGH);
        Serial.println("LED TURNED ON");
      } 
      else {
        digitalWrite(ledPin, LOW);
        Serial.println("LED TURNED OFF");
      }

    } else {
      Serial.print("HTTP Error: ");
      Serial.println(httpResponseCode);
    }

    http.end();

  } else {
    Serial.println("WiFi Disconnected");
  }

  delay(15000);   // ThingSpeak limit
}
